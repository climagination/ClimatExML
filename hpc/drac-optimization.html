
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Performance and Optimization &#8212; ClimatEx Statistical Downscaling</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css?v=6644e6bb" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=36754332"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'hpc/drac-optimization';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="How to build docs" href="../build_docs.html" />
    <link rel="prev" title="Batch Job Submission" href="drac-batch.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/climatex.png" class="logo__image only-light" alt="ClimatEx Statistical Downscaling - Home"/>
    <script>document.write(`<img src="../_static/climatex.png" class="logo__image only-dark" alt="ClimatEx Statistical Downscaling - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    ClimatExML Documentation
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../preprocessing.html">Preprocessing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installing.html">Installing ClimatExML</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tracking.html">Tracking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../training.html">Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="../customizing.html">Customize</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infering.html">Inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../performance.html">Performance</a></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="index.html">HPC Deployment Guide</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="drac-setup.html">Environment Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="drac-interactive.html">Interactive Sessions</a></li>
<li class="toctree-l2"><a class="reference internal" href="drac-batch.html">Batch Jobs</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Performance and Optimization</a></li>






</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../build_docs.html">How to build docs</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/nannau/ClimatExML" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/nannau/ClimatExML/issues/new?title=Issue%20on%20page%20%2Fhpc/drac-optimization.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/hpc/drac-optimization.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Performance and Optimization</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Performance and Optimization</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#optimization-workflow">Optimization Workflow</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#key-performance-metrics">Key Performance Metrics</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#gpu-memory-usage">GPU Memory Usage</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#gpu-power-usage">GPU Power Usage</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#tuning-parameters">Tuning Parameters</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#batch-size">Batch Size</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#precision-mode">Precision Mode</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#number-of-workers">Number of Workers</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dataloader-optimizations">DataLoader Optimizations</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#monitoring-performance">Monitoring Performance</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#during-training-real-time">During Training (Real-time)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#after-training">After Training</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#common-performance-issues">Common Performance Issues</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#issue-low-gpu-utilization-50">Issue: Low GPU Utilization (&lt;50%)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#issue-gpu-memory-oom">Issue: GPU Memory OOM</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#issue-data-loading-bottleneck">Issue: Data Loading Bottleneck</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#optimal-configuration-for-nibi-h100s">Optimal Configuration for Nibi H100s</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#benchmarking-checklist">Benchmarking Checklist</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#additional-resources">Additional Resources</a></li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="performance-and-optimization">
<h1>Performance and Optimization<a class="headerlink" href="#performance-and-optimization" title="Link to this heading">#</a></h1>
<p><strong>Tested on:</strong> Nibi cluster (H100 GPUs)
<strong>Last updated:</strong> October 2025</p>
<p>Optimizing your training performance on DRAC ensures efficient use of compute resources and faster experiment iteration. This section covers key metrics to monitor and parameters to tune for H100 GPUs on Nibi.</p>
<section id="optimization-workflow">
<h2>Optimization Workflow<a class="headerlink" href="#optimization-workflow" title="Link to this heading">#</a></h2>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p><strong>Use interactive sessions for optimization.</strong> Request a GPU allocation (see <a class="reference internal" href="#interactive.md"><span class="xref myst">Interactive Sessions</span></a>) and use the synthetic data loader to quickly iterate on performance tuning without waiting for data transfer.</p>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Request interactive session for optimization</span>
salloc<span class="w"> </span>--time<span class="o">=</span><span class="m">02</span>:00:00<span class="w"> </span>--mem<span class="o">=</span>80G<span class="w"> </span>--cpus-per-task<span class="o">=</span><span class="m">8</span><span class="se">\</span>
--account<span class="o">=</span>def-yourpi<span class="w"> </span>--gres<span class="o">=</span>gpu:h100:1

<span class="c1"># Connect and setup</span>
srun<span class="w"> </span>--pty<span class="w"> </span>bash
module<span class="w"> </span>purge
module<span class="w"> </span>load<span class="w"> </span>cuda/12.9
<span class="nb">source</span><span class="w"> </span>/path/to/climatexvenv/bin/activate

<span class="c1"># Run training with synthetic data for quick testing</span>
python<span class="w"> </span>train.py<span class="w"> </span>--use_synthetic_data
</pre></div>
</div>
</section>
</section>
<section id="key-performance-metrics">
<h1>Key Performance Metrics<a class="headerlink" href="#key-performance-metrics" title="Link to this heading">#</a></h1>
<section id="gpu-memory-usage">
<h2>GPU Memory Usage<a class="headerlink" href="#gpu-memory-usage" title="Link to this heading">#</a></h2>
<p><strong>Target:</strong> ~90% of available VRAM (72GB of 80GB on H100)</p>
<p>This metric shows how much GPU memory is allocated. Monitor this in Comet (see <span class="xref std std-doc">tracking</span> for setup) under “GPU memory usage.”</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><strong>Do not confuse with “GPU memory utilization”</strong> - that measures how much of the allocated memory is actively being used at any given moment, not total allocation.</p>
</div>
<p><strong>How to optimize:</strong></p>
<ul class="simple">
<li><p>Increase batch size if usage is low (&lt;70%)</p></li>
<li><p>Decrease batch size if hitting OOM errors</p></li>
<li><p>Use powers of 2 for batch sizes: 4, 8, 16, 32, 64, 96, 128…</p></li>
</ul>
<p><strong>Recommended starting point:</strong> Batch size of 96 works well for typical ClimatExML models.</p>
</section>
<section id="gpu-power-usage">
<h2>GPU Power Usage<a class="headerlink" href="#gpu-power-usage" title="Link to this heading">#</a></h2>
<p><strong>Target:</strong> 550-650W average during training</p>
<p>Monitor power draw in Comet or with <code class="docutils literal notranslate"><span class="pre">nvidia-smi</span></code>. Lower power usage may indicate the GPU is not being fully utilized.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Monitor power in real-time during interactive session</span>
watch<span class="w"> </span>-n<span class="w"> </span><span class="m">1</span><span class="w"> </span>nvidia-smi
</pre></div>
</div>
<p>Look for the “Power Draw / Cap” column - you want to see consistent usage in the 550-650W range.</p>
<p><strong>Low power usage (&lt;500W) may indicate:</strong></p>
<ul class="simple">
<li><p>Data loading bottleneck (GPU waiting for data)</p></li>
<li><p>Insufficient batch size</p></li>
<li><p>Too few DataLoader workers</p></li>
</ul>
</section>
</section>
<section id="tuning-parameters">
<h1>Tuning Parameters<a class="headerlink" href="#tuning-parameters" title="Link to this heading">#</a></h1>
<section id="batch-size">
<h2>Batch Size<a class="headerlink" href="#batch-size" title="Link to this heading">#</a></h2>
<p>Batch size has the largest impact on GPU memory usage and training speed.</p>
<p><strong>Finding optimal batch size:</strong></p>
<ol class="arabic simple">
<li><p>Start with a power of 2 (e.g., 32)</p></li>
<li><p>Monitor GPU memory usage in Comet or  <code class="docutils literal notranslate"><span class="pre">nvidia-smi</span></code></p></li>
<li><p>Increase incrementally: 32 → 64 → 96 → 128</p></li>
<li><p>Stop when you reach ~90% memory usage or hit OOM</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># In your training config</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">96</span>  <span class="c1"># Good starting point for H100</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>CRPS Loss Considerations:</strong> If using CRPS-based loss functions with multiple realizations per batch member, you’ll need to reduce batch size accordingly to stay within memory limits.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Batch size increases are not linear with memory usage. Trial and error is necessary to find the sweet spot.</p>
</div>
</section>
<section id="precision-mode">
<h2>Precision Mode<a class="headerlink" href="#precision-mode" title="Link to this heading">#</a></h2>
<p>H100 GPUs are optimized for bfloat16 (bf16) computation and should use bf16 instead of the default mixed precision (fp16).</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="c1"># In config.yaml</span>
<span class="w"> </span><span class="nt">precision</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bf16-mixed</span><span class="w"> </span><span class="c1"># Use bf16, not 16-mixed (fp16)</span>
</pre></div>
</div>
<p>See <span class="xref std std-doc">customizing</span> for full configuration details.</p>
<p><strong>Benefits on H100:</strong></p>
<ul class="simple">
<li><p>~2x training speedup vs fp32</p></li>
<li><p>More stable than fp16 (wider dynamic range)</p></li>
<li><p>Optimized for H100 Tensor Cores</p></li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Default mixed precision uses fp16. Always explicitly set <code class="docutils literal notranslate"><span class="pre">bf16-mixed</span></code> for H100s.</p>
</div>
</section>
<section id="number-of-workers">
<h2>Number of Workers<a class="headerlink" href="#number-of-workers" title="Link to this heading">#</a></h2>
<p>DataLoader workers handle data loading in parallel. Match this to your CPU allocation.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># In your DataLoader configuration</span>
<span class="n">num_workers</span> <span class="o">=</span> <span class="mi">8</span>  <span class="c1"># Match --cpus-per-task in SLURM script</span>
<span class="err">`</span> <span class="err">``</span>

<span class="err">```</span> <span class="n">bash</span>
<span class="c1"># In your SLURM script</span>
<span class="c1">#SBATCH --cpus-per-task=8  # Should match num_workers` </span>
</pre></div>
</div>
<p><strong>Guidelines:</strong></p>
<ul class="simple">
<li><p>Start with  <code class="docutils literal notranslate"><span class="pre">num_workers</span> <span class="pre">=</span> <span class="pre">cpus-per-task</span></code></p></li>
<li><p>Too few workers: GPU waits for data (low power usage)</p></li>
<li><p>Too many workers: Overhead from context switching</p></li>
</ul>
</section>
<section id="dataloader-optimizations">
<h2>DataLoader Optimizations<a class="headerlink" href="#dataloader-optimizations" title="Link to this heading">#</a></h2>
<p>Several PyTorch DataLoader options can significantly improve performance:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
    <span class="n">dataset</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">96</span><span class="p">,</span>
    <span class="n">num_workers</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
    <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>           <span class="c1"># Faster CPU-to-GPU transfer</span>
    <span class="n">persistent_workers</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>    <span class="c1"># Keep workers alive between epochs</span>
    <span class="n">prefetch_factor</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>         <span class="c1"># Pre-load 4 batches per worker</span>
<span class="p">)</span>
</pre></div>
</div>
<p><strong>Key parameters:</strong></p>
<ul class="simple">
<li><p><strong><code class="docutils literal notranslate"><span class="pre">pin_memory=True</span></code></strong>: Enables faster data transfer to GPU (recommended for CUDA)</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">persistent_workers=True</span></code></strong>: Avoids worker restart overhead between epochs</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">prefetch_factor=4</span></code></strong>: Number of batches each worker pre-loads</p></li>
</ul>
</section>
</section>
<section id="monitoring-performance">
<h1>Monitoring Performance<a class="headerlink" href="#monitoring-performance" title="Link to this heading">#</a></h1>
<section id="during-training-real-time">
<h2>During Training (Real-time)<a class="headerlink" href="#during-training-real-time" title="Link to this heading">#</a></h2>
<p><strong>Option 1: Comet Dashboard</strong></p>
<p>Comet automatically tracks GPU metrics in real-time. See <span class="xref std std-doc">tracking</span> for setup instructions.</p>
<p>Key metrics to watch:</p>
<ul class="simple">
<li><p>GPU memory usage (target: ~90%)</p></li>
<li><p>GPU power draw (target: 550-650W)</p></li>
<li><p>Training throughput (samples/sec)</p></li>
</ul>
<p><strong>Option 2: nvidia-smi (Interactive Sessions)</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># In an interactive session, SSH to your compute node</span>
watch<span class="w"> </span>-n<span class="w"> </span><span class="m">1</span><span class="w"> </span>nvidia-smi

<span class="c1"># Look for:</span>
<span class="c1"># - Memory-Usage: should be ~72000MiB / 81920MiB (90%)</span>
<span class="c1"># - Power Draw: should be 550-650W</span>
<span class="c1"># - GPU-Util: should be high (&gt;80%)</span>
</pre></div>
</div>
</section>
<section id="after-training">
<h2>After Training<a class="headerlink" href="#after-training" title="Link to this heading">#</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check job efficiency</span>
seff<span class="w"> </span>JOBID

<span class="c1"># Shows:</span>
<span class="c1"># - CPU efficiency</span>
<span class="c1"># - Memory efficiency </span>
<span class="c1"># - Job duration` </span>
</pre></div>
</div>
</section>
</section>
<section id="common-performance-issues">
<h1>Common Performance Issues<a class="headerlink" href="#common-performance-issues" title="Link to this heading">#</a></h1>
<section id="issue-low-gpu-utilization-50">
<h2>Issue: Low GPU Utilization (&lt;50%)<a class="headerlink" href="#issue-low-gpu-utilization-50" title="Link to this heading">#</a></h2>
<p><strong>Symptoms:</strong></p>
<ul class="simple">
<li><p>Low power usage (&lt;400W)</p></li>
<li><p>Low GPU utilization percentage</p></li>
<li><p>Slow training</p></li>
</ul>
<p><strong>Solutions:</strong></p>
<ol class="arabic simple">
<li><p>Increase batch size</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">bf16-mixed</span></code> precision</p></li>
<li><p>Increase  <code class="docutils literal notranslate"><span class="pre">num_workers</span></code>  in DataLoader</p></li>
<li><p>Enable DataLoader optimizations (<code class="docutils literal notranslate"><span class="pre">pin_memory</span></code>,  <code class="docutils literal notranslate"><span class="pre">persistent_workers</span></code>)</p></li>
<li><p>Verify data is in  <code class="docutils literal notranslate"><span class="pre">$SLURM_TMPDIR</span></code>  (not reading from network storage)</p></li>
</ol>
</section>
<section id="issue-gpu-memory-oom">
<h2>Issue: GPU Memory OOM<a class="headerlink" href="#issue-gpu-memory-oom" title="Link to this heading">#</a></h2>
<p><strong>Symptoms:</strong></p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="err">`</span><span class="n">RuntimeError</span><span class="p">:</span><span class="w"> </span><span class="n">CUDA</span><span class="w"> </span><span class="k">out</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">memory</span><span class="err">`</span><span class="w"> </span>
</pre></div>
</div>
<p><strong>Solutions:</strong></p>
<ol class="arabic simple">
<li><p>Reduce batch size</p></li>
</ol>
</section>
<section id="issue-data-loading-bottleneck">
<h2>Issue: Data Loading Bottleneck<a class="headerlink" href="#issue-data-loading-bottleneck" title="Link to this heading">#</a></h2>
<p><strong>Symptoms:</strong></p>
<ul class="simple">
<li><p>Low GPU utilization despite reasonable batch size</p></li>
<li><p>High CPU usage</p></li>
<li><p>Training speed doesn’t improve with more workers</p></li>
</ul>
<p><strong>Solutions:</strong></p>
<ol class="arabic simple">
<li><p>Verify data is in  <code class="docutils literal notranslate"><span class="pre">$SLURM_TMPDIR</span></code>, not network storage</p></li>
<li><p>Use synthetic data loader to test if data I/O is the bottleneck</p></li>
</ol>
</section>
</section>
<section id="optimal-configuration-for-nibi-h100s">
<h1>Optimal Configuration for Nibi H100s<a class="headerlink" href="#optimal-configuration-for-nibi-h100s" title="Link to this heading">#</a></h1>
<p>Based on testing, these settings work well for typical ClimatExML training:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="sb">`</span><span class="c1"># SLURM settings</span>
<span class="c1">#SBATCH --gres=gpu:h100:1</span>
<span class="c1">#SBATCH --cpus-per-task=8</span>
<span class="c1">#SBATCH --mem=80G` </span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># DataLoader settings</span>
<span class="n">DataLoader</span><span class="p">(</span>
    <span class="n">dataset</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">96</span><span class="p">,</span>
    <span class="n">num_workers</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
    <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">persistent_workers</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">prefetch_factor</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p><strong>Expected performance:</strong></p>
<ul class="simple">
<li><p>GPU memory usage: ~72GB / 80GB (90%)</p></li>
<li><p>Power draw: 550-650W average</p></li>
<li><p>GPU utilization: &gt;80%</p></li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>These are starting points. Your optimal settings may vary depending on model architecture, input data size, and loss function. Always benchmark with your specific configuration.</p>
</div>
<section id="benchmarking-checklist">
<h2>Benchmarking Checklist<a class="headerlink" href="#benchmarking-checklist" title="Link to this heading">#</a></h2>
<p>Before running long training jobs:</p>
<ul class="contains-task-list simple">
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> Test with synthetic data loader in interactive session</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> Verify GPU memory usage is ~90%</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> Check power draw is 550-650W</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> Confirm no data loading bottlenecks</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> Validate DataLoader settings match CPU allocation</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> Monitor first few epochs in Comet dashboard</p></li>
</ul>
</section>
</section>
<section id="additional-resources">
<h1>Additional Resources<a class="headerlink" href="#additional-resources" title="Link to this heading">#</a></h1>
<ul class="simple">
<li><p><span class="xref std std-doc">../trackingtracking</span>  - Setting up Comet for metric tracking</p></li>
<li><p><a class="reference internal" href="drac-interactive.html"><span class="doc">Interactive Sessions on DRAC</span></a>  - Using interactive sessions for optimization</p></li>
<li><p><a class="reference external" href="https://pytorch.org/docs/stable/data.html">PyTorch DataLoader Documentation</a></p></li>
<li><p><a class="reference external" href="https://docs.nvidia.com/deeplearning/performance/">NVIDIA GPU Performance Guide</a></p></li>
</ul>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./hpc"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="drac-batch.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Batch Job Submission</p>
      </div>
    </a>
    <a class="right-next"
       href="../build_docs.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">How to build docs</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Performance and Optimization</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#optimization-workflow">Optimization Workflow</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#key-performance-metrics">Key Performance Metrics</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#gpu-memory-usage">GPU Memory Usage</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#gpu-power-usage">GPU Power Usage</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#tuning-parameters">Tuning Parameters</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#batch-size">Batch Size</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#precision-mode">Precision Mode</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#number-of-workers">Number of Workers</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dataloader-optimizations">DataLoader Optimizations</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#monitoring-performance">Monitoring Performance</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#during-training-real-time">During Training (Real-time)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#after-training">After Training</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#common-performance-issues">Common Performance Issues</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#issue-low-gpu-utilization-50">Issue: Low GPU Utilization (&lt;50%)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#issue-gpu-memory-oom">Issue: GPU Memory OOM</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#issue-data-loading-bottleneck">Issue: Data Loading Bottleneck</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#optimal-configuration-for-nibi-h100s">Optimal Configuration for Nibi H100s</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#benchmarking-checklist">Benchmarking Checklist</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#additional-resources">Additional Resources</a></li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Nic Annau
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>